# Настройка удаленного доступа по SSH

## Алгоритмы шифрования

- Симметричные алгоритмы шифрования требуют наличия у абонентов общего секретного ключа
- Асимметричные алгоритмы требуют выпуска каждым абонентом пары ключей, один из которых является приватным и не
  распространяется по сети, второй - публичный и может быть передан, в том числе по открытым каналам связи

- Для создания общего секретного ключа для симметричного шифрования применяется алгоритм Диффи-Хеллмана
- Асимметричный алгоритм шифрования подразумевает использование пары ключей - приватного и публичного. Если текст
  зашифрован одним ключом пары, расшифровать его можно только с применением второго ключа этой же пары.
- Приватный ключ никогда не должен покидать того расположения, где он был создан. Публичный ключ может свободно
  распространяться по открытым каналам связи
- Между приватным и публичным ключом существует математическая связь, но подбор приватного ключа по публичному является
  алгоритмически сложной задачей, время решения которой крайне велико
- Асимметричные алгоритмы используются для аутентификации. Абонент, подлинность которого необходимо проверить, создает
  пару: приватный и публичный ключ, и передает публичный ключ другому абоненту (по защищенному каналу связи).
- Когда требуется проверка одного абонента другим, проверяющий абонент создает одноразовую секретную фразу, шифрует ее
  публичным ключом проверяемого абонента
- Если проверяемый абонент смог с помощью приватного ключа расшифровать секретную фразу и предоставить ее проверяющему
  абоненту, то проверка считается пройденной, а подлинность проверяемого абонента - установленной.

## Алгоритм Диффи-Хеллмана

- Позволяет при работе по незащищенному от прослушивания каналу связи создать двум участникам общий секретный ключ, не
  доступный третьей (прослушивающей) стороне, который дальше будет применен для шифрования с использованием алгоритма
  симметричного шифрования
- Алгоритм не защищен от атаки "Человек посередине" (man in the middle), поэтому для аутентификации, как правило,
  применяют алгоритм RSA

## Служба `ssh`

- Предоставляет возможность удаленной работы в командном интерпретаторе, используя аутентификацию пользователей и
  шифрование передаваемых данных
- Позволяет также копировать файлы, используя `scp` и `sftp`
- Позволяет осуществлять проброс портов с одной машины на другую
- Имя службы: `sshd`, имя клиента: `ssh`
- Запуск/статус/остановка/перезапустить/перечитать конфигурацию/включить/исключить автозагрузку:
    - `systemctl start/status/stop/restart/reload/enable/disable sshd.service`

- Узнать, запущена ли служба sshd: `systemctl status sshd.service`
    - Примечание: можно использовать альтернативное имя службы (юнита) - `ssh.service`
- Запуск службы sshd, если она не запущена: `systemctl start sshd.service`
- Перечитывание настроек службы без ее перезапуска: `systemctl reload sshd.service`
- Добавить в автозагрузку (если sshd установлен, но автоматически не стартует после перезагрузки машины): `systemctl
  enable sshd.service`
- Если служба sshd не была установлена при установке системы, то можно установить с помощью команды: `sudo apt install
  openssh-server -y`
- Конфигурационный файл для клиента `ssh`: `/etc/ssh/ssh_config`
    - Получение справки по настройке клиента: `man 5 ssh_config`
- Конфигурационный файл для службы `sshd`: `/etc/ssh/sshd_config`
    - Получение справки по настройке службы: `man 5 sshd_config`
- `~/.ssh/config` - индивидуальные (пользовательские) настройки клиента

## Настройка аутентификации по ключам

- Используется алгоритм асимметричного шифрования RSA
- Пара ключей представлена публичным и приватным ключами
- Ключи на клиенте хранятся в каталоге `~/.ssh` в файлах:
    - `id_rsa` - приватный ключ пользователя
    - `id_rsa.pub` - публичный ключ пользователя
    - `known_hosts` - публичные ключи ssh-серверов
- Публичный ключ пользователя с клиента передается на сервер и добавляется в файл `-/.ssh/authorized_keys`

## Настройка аутентификации по ключам

- `ssh-keyscan` - получение публичного ключа сервера, который записывается в `known_hosts`
- `ssh-keygen` - создание пары публичного и приватного ключей на клиенте (по умолчанию имя `id_rsa`, можно задать иное,
  парольная фраза - для шифрования приватного ключа)
- `ssh-copy-id` - копирование публичного ключа клиента на сервер
- `ssh-agent` - кэширование приватных ключей
- `ssh-add` - добавление ключей в кэш агента

## Основные клиентские команды

- `ssh username@host` - для терминального подключения к серверу
- `scp somefile username@hostname:path` - копирование файла на удаленную машину
- `scp username@hostname:path localpath` - копирование файла на локальную машину
- `sshfs username@hostname:path ~/mount_point` - монтирование удаленной файловой системы по `ssh` в локальный
  (`-/mount_point`)
- `fusermount -u ~/mount_point` - размонтировать файловую систему, подключенную по `ssh`

## Переадресация локального порта

- Переадресация локального порта позволяет получить доступ с компьютера пользователя к службе, запущенной на удаленном
  хосте, к которому нет доступа с компьютера пользователя, но есть доступ с SSH-сервера.

- "Прямой" туннель - проброс порта локального хоста на порт сервера:
    - `ssh -fnN -L локальный_порт:адрес_сервера:порт_сервера user@адрес_SSH_сервера`

- На компьютере пользователя (Local) следует обращаться к удаленной службе, как к локальной, при этом указывая локальный
  порт, заданный при переадресации порта
    - Например: выполнив команду `links2 http://localhost:8000`, получаем доступ к службе работающей на хосте Server,
      порт 80

## Переадресация удаленного порта

- "Обратный" туннель - проброс порта удаленного компьютера на порт сервера:
    - `ssh -fnN -R удаленный_порт:адрес_сервера:порт_сервера user@адрес_SSH_сервера`
- Переадресация удаленного порта используется, когда пользователь на своем компьютере (Local) создает ssh-соединение и
  "публикует" службу, запущенную на сервере (Server) на ssh-сервере

- При использовании переадресации удаленного порта для доступа к службе, запущенной на сервере (Server), следует
  обратиться к ssh-серверу, указав удаленный порт, заданный при переадресации
    - Пример: выполнив команду `links2 http://ssh_server:8000` с любого хоста, у которого есть доступ к ssh-серверу,
      получаем доступ к службе, работающей на хосте Server (порт 80).
- По умолчанию "публикация" службы на ssh-сервере производится на локальном сетевом интерфейсе `127.0.0.1`

## Туннели в `ssh`: SOCKS-прокси

- SSH поддерживает динамическую переадресацию портов, с помощью которой на локальном хосте можно создать сокет
  прокси-сервера, работающего по протоколам `SOCKS4/5`
    - `ssh -fN -D IP_адрес_хоста:порт \user@адрес_SSH_сервера`
