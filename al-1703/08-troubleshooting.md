# Поиск и устранение неисправностей

## Методология поиска и устранения неисправностей

### Виды нештатных ситуаций

- Отключение электричества
- Сбой в локальной вычислительной сети
- Выход из строя сервера
- Потеря данных
    - отсутствие возможности сохранить данные
    - отсутствие связи с сервером
    - поврежедение файлов
- Обнаружен вирус
- Обнаружена утечка информации
- Взлом системы или несанкционированный доступ
    - обнаружены попытки подбора пароля
    - доступ постороннего лица в помещение
- Компрометация ключей и пароля
    - утеря носителя
    - визуальный осмотр носителя информации посторонним лицом
    - взлом учетной записи пользователя
- Физическое повреждение ЛВС(локальной вычислительной сети) или ПК
    - отсутствие доступа в локальную сеть, интернет, связи с сервером
    - не включается ПК, синий/черный экран
- Стихийное бедствие

### Анализ журналов системы на предмет выявления нештатных и аварийных перезагрузок

Просмотр, когда именно произошла перезагрузка систем:
- `who -b`
- `last | grep reboot`

Анализ журнала `systemd`:
- `mkdir /var/log/journal/`
- `grep Storage /etc/systemd/journald.conf`
- `systemctl restart systemd-journald`
- `journalctl --list-boots`

### Выявление ситуаций "паника ядра"

Kernel Panic - это ошибка низкого уровня (обычно на неисправном оборудовании), которую система не может восстановить

- Паника ядра обычно возникает тогда, когда не удалось запустить `init`, так как, несмотря на запущенное и
  работоспособное ядро, сама система остаётся непригодной к дальнейшей работе
- Также, в этом случае создаются записи в журналах, сообщающие об ошибках

Возможные причины для Kernel Panic:
- Отказ оперативной памяти
- Программные ошибки или вредоносное ПО
- Неисправное оборудование (например, оперативная память)
- Несовместимые драйвера
- Ошибка в самом ядре операционной системы

### Подготовка информации для отправки разработчикам

- `Core dump` (дамп памяти) - содержимое рабочей памяти одного процесса, ядра или всей операционной системы. Также может
  включать дополнительную информацию о состоянии программы или системы, например, значения регистров процессора
- Настройка создания дампа для аварийно завершившегося приложения:
    - `sudo ulimit -c unlimited`
    - `sudo sysctl -w kernel.core_pattern=/tmp/core_%e.%p.%h.%t`

- Для включения возможности снимать дампы для аварийно завершившихся приложений вносим изменения в файле
  `/etc/security/limits.conf`
* soft core unlimited
- Создаем каталог для дампов:
    - `mkdir /cores`
    - `chmod 1777 /cores`
- Указываем формат и место сохранения дампов в `/etc/sysctl.conf`:
    - `kernel.core_pattern = /cores/core_%e.%p`

- `Sos report` - это инструмент, который создает архив конфигурации и диагностических данных работающей системы
- `sos report` собирает информацию о системе, такую как:
    - состояние ядра
    - загруженные модули
    - информацию о сети
    - конфигурацию оборудования

## Устранение неисправностей, возникающих на начальных стадиях загрузки системы

- Режим восстановления (общий случай) может быть использован для:
    - доступа к корневому разделу исправления ошибок на диске
    - сброса счетчика неудачных попыток входа
    - восстановления пароля

## Неисправности на начальных стадиях загрузки

- Повреждение MBR, EFI, повреждение GRUB и файлов в `/boot`
- Ошибки, возникающие в процессе установки ОС
- Пример ошибки возникающей в процессе установки ОС (когда установка происходит в UEFI режиме, но таблица диска MBR):
    - Не удалось выполнить команду "grub-install dumny". Это неисправимая ошибка.

## Пример восстановления загрузчика

- После загрузки в режиме восстановления и запуска оболочки:
    - Запустить пакетный менеджер
    - Убедиться, какой пакет `grub` установлен
- Заменить пакет `grub` (при необходимости)
- Провести установку загрузчика на устройство
- Выполнить обновление списка систем: `update-grub`

## Устранение неисправностей связанных с нехваткой места в каталоге `/boot`

- Проверить содержимое каталога `/boot`:
- Удалить ненужные файлы (например, если не используется ядро hardened, можно удалить файлы, относящиеся к этому ядру)
    - `ls -lh /boot`


## Устранение неисправностей, возникающих на заключительных стадиях загрузки системы

- Решение проблем, связанных с устройствами хранения данных
- Решение проблем, связанных со входом пользователей в систему

## Восстановление разделов диска

- Утилиты:
    - `testdisk`
    - `fsck` - проверка и восстановление поврежденных файловых систем
- Восстановление поврежденной файловой системы, пример:
    - `sudo umount /dev/sdc1`
    - `sudo fsck -p /dev/sdc1`
    - `sudo mount /dev/sdc1`

## Процесс восстановления разделов диска

- Если надо проверить или восстановить корневую файловую систему, то:
    - можно настроить запуск `fsck` при загрузке
    - загрузить систему в режиме восстановления
    - использовать установочный диск в режиме восстановления
    - использовать live CD с любой ОС Linux

## Замена неисправного дискового устройства

- Утилита `badblocks`
- Примеры:
    - `sudo badblocks -v /dev/sda2 -0 ~/bad_sectors.txt`
    - `sudo badblocks -vn /dev/sda2 -0 ~/bad_sectors.txt`
    - `fsck -l ~/bad_sectors. txt /dev/sda1`

## Изучение проблем с входом пользователей в систему

- Восстановление потерянных паролей обычным пользователем и администратором
    - Для восстановления пароля администратора или восстановления пароля обычного пользователя (при отсутствии доступа к
      аккаунту администратора), сбросить пароль можно с использованием загрузчика GRUB.
- Устранение ошибок при входе пользователя с терминала
- Изучение проблем, связанных с потерей/удалением файлов и каталогов

## Восстановление пароля учетной записи администратора

- Загрузиться с установочного диска ОС и выбрать **Режим восстановления**
- Выбрать устройство, используемое в качестве корневой системы (например, `/dev/sda1`)
- Запустить оболочку в `/dev/sda1`
- Перейти в терминал (Alt-F2*) и выполнить `chroot /target`
- С помощью текстового редактора удалить хеш пароля у пользователя в файлах: `/etc/shadow`, `/etc/shadow-`
- Перезагрузить машину и выполнить вход без пароля с последующей его установкой

## Изучение проблем, связанных с потерей/удалением файлов и каталогов

- Неправильные действия пользователей - сам человек нечаянно или по неопытности уничтожает данные. Если после потери
  информации компьютер был практически сразу выключен, то восстановить данные, как правило, можно.
- Программно-аппаратные неисправности - например, работа вируса, сбой операционной системы или программного обеспечения,
  выход из строя жесткого диска.
- Физические повреждения - происходят из-за сильных ударов или в результате влияния сильного магнитного поля. В этом
  случае требуется специальное оборудование для восстановления данных.

## Восстановление файлов

- `testdisk`
- В состав пакета входят два инструмента:
    - `testdisk` - восстановление повреждённой структуры дисковых разделов и повреждённой файловой структуры в этих
      разделах
    - `photorec` - поиск и извлечение видео и изображений из повреждённой файловой структуры путём прямого доступа к
      данным

- Инструмент `testdisk` выполняет анализ информации, хранящейся в заданном блочном устройстве, и пытается найти
  известные ему структуры данных (дисковые разделы, таблицы файлов, каталоги и пр.)

- `photorec` не использует файловую структуру, а анализирует содержимое заданного устройства, пытаясь по содержимому
  определить известные ему типы файлов и извлечь их

---

С помощью какой команды можно проверить диск на битые блоки?
- `sudo badblocks -v /dev/sda1 > badsectors.txt` - проверить раздел `/dev/sda1` и записать список битых секторов в файл

С помощью какой команды можно сбросить счетчик числа неудачных попыток ввода пароля для пользователя?

В каких файлах нужно удалить хеш пароля для того, чтобы пользователь мог зайти в ОС без ввода пароля?
