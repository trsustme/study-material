# Расширенное администрирование устройств хранения данных


## Управление логическими томами LVM

Управление логическими томами (LVM) - это способ абстрагировать физическое управление томами в системе в
высокоуровневую.

Работа с томами с помощью LVM происходит на 3-х уровнях абстракции:

- Физический уровень (PV) - Сначала диск инициализируется командой `pvcreate` - в начале диска создается дескриптор
  группы томов. При этом, физические тома разбиваются на физические экстенты (physical extent, PE).
    - `sudo pvcreate /dev/sdb`
    - `pvscan` - сканирование дисков на предмет PV
    - `pvs` - вывод информации о PV
    - `pvdisplay` - вывод атрибутов PV

- Группа томов (VG). С помощью команды `vgcreate` создается группа томов из инициализированных на предыдущем этапе
  дисков.
    - `vgdisplay` - вывод информации о группе томов
    - `vgscan` - сканировние дисков на наличие VG
    - `vgs` - вывод информации о VG

- Логический том (LV). Группы томов нарезаются на логические тома (разделы) командой `lvcreate`.
    - `lvdisplay` - вывести информацию об атрибутах логических томов
    - `lvscan` - вывести список всех логических томов во всех группах томов
    - `lvs` - вывести информацию о логических томах

## Порядок работы

- Создать физические тома
- Создать группу томов
- Создать логические тома
- Отформатировать логические тома
- Смонтировать логические тома

`sudo ant install lvm2 -v` - установка пакета LVM

### Создание физических томов

`sudo mkfs.ext4 /dev/vq01/lv01` - создание файловой системы логического тома

### Создание группы томов

`sudo vgcreate vg01 /dev/sdb /dev/sdc` - создание группы томов

### Создание логического тома

`sudo lvcreate -L 9G -n lv01 vg01` - создание логического тома, большего размера, чем каждый из физических томов по
отдельности

### Создание ФС логического тома

`sudo mkfs.ext4 /dev/va01/1v01`

### Монтирование логического тома
- `sudo mkdir /data` - создаем точку монтирования
- `sudo mount /dev/vg01/lv01 /data` - монтируем том в командной строке
- `sudo systemctl .-full --force edit data.mount` - создаем юнит systemd для монтирования

Будет вызван редактор для редактирования файла
- `/etc/systemd/system/data.mount`

### Юнит systemd для монтирования

Создаем юнит `systemd` для монтирования

```bash
[Unit]
Description=Mount data # описание точки монтирования

[Mount]
What=/dev/vg01/Lv01 # что будем монтировать
Where=/data # куда будем монтировать
Type=ext4 # тип файловой системы
Option=defaults, noexec # какие параметры монтирования следует применить

[Install] # указывается то, что unit файл будет активирован в момент времени, когда система будет готова к монтированию
WantedBy=multi-user.target
```
Затем нужно перечитать конфигурацию `systemd` и активировать unit-файл:
- `sudo systemctl daemon-reload`
- `sudo systemctl enable data.mount`

### Проверка ФС на наличие ошибок

Перед проверкой файловой системы на наличие ошибок, необходимо размонтировать данный том:
- `sudo systemctl stop data.mount`

`sudo fsck.ext4 /dev/vq01/lv01` - проверит ФС на наличие ошибок
или
`sudo e2fsck -f /dev/vq01/lv01`

### Удаление физического тома

- Перед удалением физического тома надо переместить экстенты с физического тома, который подлежит удалению:
- `sudo pvmove /dev/sdb`

Командой `vgreduce` физический том удаляем из группы томов:
- `sudo vgreduce vads /dev/sdh`

Удаляем физический том:
- `sudo pvremove /dev/sdb`


## Методы шифрования данных

- Шифрование на уровне файловой системы:
    - eCryptfs
    - EncFS
- Блочное шифрование на уровне устройства:
    - Loop-AES
    - TrueCrypt
    - dm-crypt+LUKS

## LUKS (Linux Unified Key Setup)

- Система криптозащиты дисков LUKS/dm-crypt, состоит из двух основных компонентов:
    - dm-crypt — стандартная подсистема шифрования дисков Linux-ядра версии 2.6, опирается на подсистему Device Mapper
      (dm) и криптографическое API (Crypto API), предоставляемое ядром и предназначенное для выполнения различных
      криптографических функций
    - LUKS (Linux Unified Key Setup) - стандарт шифрования дисковых устройств для Linux, который описывает дисковый
      формат для зашифрованных данных

## Работа с разделом LUKS

- `cryptsetup` - утилита для управления шифрованием дисков позволяет:
    - Создавать шифрованные разделы LUKS
    - Открывать и закрывать разделы LUKS
    - Управлять слотами ключей
    - Делать дамп заголовка LUKS и мастер-ключа

## Шифрование жесткого диска

- `sudo cryptsetup luksFormat /dev/sdd`

