# Управление устройствами и модулями ядра

## Псевдофайловая система sysfs

Ядро экспортирует информацию об устройствах и драйверах в пользовательское пространство (userspace) с помощью
псевдофайловой системы `sysfs,` которая монтируется в каталог `/sys`
Основные подкаталоги sysfs:
- `devices/` - дерево устройств
- `block/` - блочные (дисковые) устройства
- `class/` - устройства, сгруппированные по классам
- `bus/` - список шин и связанных с ними устройств и драйверов
- `dev/` - информация о файлах устройств
- `fs/` - информация о файловых системах

B sysfs также хранится информация об ядре ОС (/sys/kernel) и о загруженных модулях ядра (/sys/module).

## Менеджер устройств `systemd-udevd`

Подсистема `udev` предназначена для настройки и управления устройствами, которые были идентифицированы ядром ОС

Подсистема `udev` состоит из служб ядра и службы `systemd-udevd,` работающей в пользовательском пространстве (userspace)

-дро ОС при добавлении или удалении hotplug устройства:
- производит соответствующие изменения во внутренней структуре дерева устройств, которая отображается в `sysfs`
- сообщает службе `systemd-udevd` о таком событии (uevent)
- служба `systemd-udevd` обрабатывает полученное событие и выполняет настройку устройства в соответствии с набором
  заданных правил (rules)

`udevadm` - утилита для управления `udevd`

## Получение информации об устройствах

Утилиты и команды для просмотра информации об устройствах:
- `Менеджер устройств`
- `lshw`

Утилиту требуется поставить дополнительно (sudo apt install lshw, для запуска в графической среде также понадобится
поставить Ishw- gtk);
- `lspci` - информация об устройствах, подключенных к шине PCI
- `lsusb` - информация об устройствах, подключенных к службе USB
- `lscpu` - информация о процессорах

Псевдофайловая система `/ргос` также хранит информацию об аппаратном обеспечении. Наиболее значимыми являются файлы:
- `/proc/cpuinfo` — информация о процессорах
- `/proc/meminfo` — информация о физической памяти

## Загрузка и управление модулями ядра

`/lib/modules` (ELF файлы) - находятся модули всех установленных ядер

`/lib/modules/$(uname -r)` - модули текущего (загруженного) ядра

`.kо` - суффикс модуля

`depmod ` - команда, которая выполняется в процессе любого изменения состава модулей, которая создает базу данных установленных модулей их зависимостей:
В процессе любого изменения состава модулей ядра выполняется команда
/lib/modules/$(uname -r)/modules.dep

## Команды для управления модулями ядра

- `lsmod` - просмотр загруженных модулей ядра
- `modinfo имя_модуля` - информация о модуле ядра
- `modprobe имя_модуля` - загрузка модуля ядра
- `modprobe -r имя_модуля` - выгрузка модуля ядра

## Конфигурационные файлы модулей ядра

- `/etc/modules` - основной конфигурационный файл (обычно пустой)
- `/etc/modules-load.d/*` - модули, которые нужно загружать при инициализации системы
- `/lib/modprobe.d/*` - «заводские» настройки
- `/etc/modprobe.d/*` - кастомизированные настройки
- `modprobe -c` - просмотр текущих настроек
- `update-initramfs -u` - обновить файл `initramfs` после изменения настроек
