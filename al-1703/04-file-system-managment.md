# Управление файловыми системами

## Виртуальная файловая система

Виртуальная файловая система (Virtual Filesystem, VFS) предоставляет процессам из пользовательского пространства (user
space) унифицированный доступ к файлам и каталогам, скрывая особенности реализации той или иной файловой системы.

B Linux поддерживаются следующие типы ФС:
- блочные (дисковые) ФС - локальные файловые системы, основанные на использовании блочных устройств
- сетевые ФС - данные находятся на сетевых устройствах (серверах), но пользовательские процессы работают с ними , как с локальными
- псевдофайловые системы (называют также виртуальными ФС) обеспечивают доступ из пользовательского пространства к
  структурам данных, хранящихся в пространстве ядра, с помощью интерфейса файловой системы
- ФС в RAM или "временные" файловые системы размещаются в оперативной памяти (электронные диски)

Модуль ядра `FUSE` (Filesystem in USEr space) и библиотека `libfuse` позволяют разработчикам создавать код файловой
системы, работающий в пользовательском пространстве, и экспортировать файловую систему в пространство ядра

Примеры реализованных ФС в пользовательском пространстве: sshfs, NTFS-3G.

VFS оперирует объектами:
- суперблок - информация о файловой системе (метаданные ФС)
- индексные дескрипторы (метаданные файла, inode)
- элемент каталога (directory entry, dentry, связывает имя файла с индексным дескриптором)
- файловые объекты - структуры, содержащие информацию об открытых файлах

## Именование файлов дисковых устройств

- `/dev/sd*` - дисковые устройства с интерфейсом последовательной передачи данных (SCSI, SATA, см. `man 4 sd`)
- `/dev/hd* `- дисковые устройства с интерфейсом параллельной передачи данных (РАТА, см. `man 4 hd`)
- Буква (a,b,c,..) после sd или hd - номер диска
- Число после буквы - номер раздела (`/dev/sdb4`)
- Если числа нет - то весь диск (`/dev/sdc`)­

В случае BIOS/MBR: поддерживается 4 первичных раздела (1-4), один из которых может объявлен, как расширенный.
В расширенном разделе могут быть созданы логические разделы (первый логический раздел: 5)

B UEFI/GPT все разделы первичные (1-128)

## Поддерживаемые типы файловые системы

- `ls /lib/modules/$(uname -r)/kernel/fs` - модули ядра (драйверы) поддерживаемых файловых систем в установленной
  операционной системе
- Список драйверов файловых систем, загруженных в данный момент
    - `cat /proc/filesystems` (`nodev` - псевдофайловые или временные файловые системы)
- Все ФС должны предоставлять VFS информацию о суперблоке, inode, dentry, блоках данных
- "Родные" для Linux ФС — ext2/ext3/ext4
- Дисковые ФС, поддерживаемые ядром: XFS, BtrFS, iso9660, udf

Кроме наличия соответствующего драйвера ФС в дистрибутиве должны быть также установлены программные пакеты, содержащие
инструменты для работы с данным типом ФС:
- ext2/3/4 - `e2fsprogs`
- XFS - `xfsprogs`
- BtrFS - `btrfs-progs`
- IS09660, UDF - `cdrskin`, `xorriso`, `growisofs`

## Файловая система `ext2`

- Макс. размер файла:
    - 16 GiB (размер блока 1 KiB)
    - 1 ТіВ (размер блока 4 КіВ)
- Макс. размер ФС:
    - 4 ТіВ (размер блока 1 КіВ)
    - 16 ТіВ (размер блока 4 КіВ)
- Пространство ФС разбито на группы блоков:
    - резервный суперблок
    - таблица описания группы
    - битовые карты inode и блоков данных
    - области inode и блоков данных (dumpe2fs)

### Суперблок ФС

- Суперблок содержит информацию о самой файловой системе (тип, размер, состояние, UUID и т.д.)
- Содержимое суперблока можно посмотреть командой: `tune2fs -l / dev/имя_раздела`

### Структура индексного дескриптора

- Размер `inode` хранится в суперблоке (128/256 байт)
- Начиная с ядра 2.6.10 - 256 байт (для хранения точного времени и расширенных атрибутов, включая метку безопасности (мандатную метку))
- Команда для просмотра `inode` для ФС ext: `debugfs -R "stat имя_файла" имя_блочного_устройства`
    - `debugfs -R "stat /" /dev/sda2 | more`
- Для адресов блоков данных отведено:
    - 12 прямых указателей
    - 1 косвенный указатель
    - 1 указатель с двойной косвенной адресацией
    - 1 - с тройной косвенной адресацией

B Astra Linux метки безопасности поддерживаются только в ФС семейства ext и xfs.

## Файловая система `ext3`

- Главные отличия от `ext2`:
    - Наличие журнала
    - Онлайн увеличение размера ФС
    - Использование сбалансированного дерева для индексирования больших каталогов - что обеспечило более быстрый поиск файлов
- `ext3` совместима с `ext2`
    - `ext2` может преобразована в `ext3` (`tune2fs -j`) и наоборот (`tune2fs -O ^has_journal`)
- Режимы работы журнала:
    - `journal` - журналируются изменения в метаданных и блоках данных файлов
        - Режим самый надежный, но и самый медленный режим работы ФС
    - `ordered` - журналируются только измененные метаданные, при этом метаданные логически группируются с
      соответствующими изменениями в данных. Сначала на диск записываются изменения в блоках данных файла, а потом
      метаданные этого файла
      - Режим включен по умолчанию
    - `writeback` - журналируются только измененные метаданные файлов, блоки данных не журналируются и не
      устанавливается связь между метаданными и соответствующими блоками данных. Порядок записи данных и метаданных на
      диск неизвестен
      - Режим обычно демонстрирует наилучшую производительность ФС, но в случае краха системы возможны проблемы с
        файлами, в которые данные или метаданные записывались непосредственно перед сбоем
- Журнал обычно размещается в конце раздела с ФС

- `tune2fs -о режим_работы журнала имя_блочного_устройства` - включение режимов работы журналов ФС
    - `journal_data,` `journal_data_ordered,` `journal_data_writeback`

## Файловая система `ext4`

- Максимальный размер ФС 1ЕіВ, файла - 16ТiВ (при размере блока 4 КіВ)
- Отличительные черты:
    - Размещение данных экстентами
        - Экстенты (extents) - непрерывная область из смежных блоков данных.
        - Один экстент может достигать размера в 128МіВ, при размере блока 4КіВ.
    - Отложенное распределение (выделение) блоков - распределение блоков откладывается до тех пор, пока не пойдет запись на диск
    - Предварительное выделение места для файла на диске
    - Контрольные суммы журнала - для определения возможных проблем в журнале

Возможна конвертация файловых систем `ext2/3` в `ext4`.

В файловых системах семейства `ext` максимальное количество индексных дескрипторов задается при форматировании дискового
устройства и не может быть изменено без повторного форматирования.

## Основные характеристики ФС `XFS`

- 64-х разрядная ФС (макс. размер файлы - 8 ЕіВ, макс размер ФС - 8 EiB)
- Увеличение производительности путем использования линейных областей (allocation groups)
- Использование экстентов для выделения места в области данных
- Журналируемая ФС (журналируются только метаданные)
- Индексные дескрипторы выделяются динамически
- Поддержка дефрагментации "на лету"
- Возможность увеличения размера ФС "на лету"
- Поддержка отложенного выделения места (delayed allocation)

## Основные характеристики ФС `Btrfs`

- 64х-разрядная ФС (макс. размер файла 16 ЕіВ, раздела - 16 ЕіВ)
- Поддержка механизма "копирования при записи" (Copy On Write, COW)
- Поддержка подтомов (subvolumes)
- Поддержка снимков состояния ФС (использует механизм COW и подтома)
- Дефрагментация и сжатие данных на "лету"
- Динамическое размещение `inode`
- Целостность данных (вычисление контрольных сумм для данных и метаданных)
- Встроенная поддержка многодисковых ФС (`RAID` и `LVM`)

## Файловая система `iso9660` и `udf`

- В файловой системе `ISO9660` применяется стандартное соглашение об именах DOS в формате 8.3 и все имена используют
  верхний регистр символов
- Расширения стандарта `ISO9660`: `Rock Ridge` и `Joliet`
- B `Rock Ridge` используются специальные файлы для отображения коротких имен в длинные и хранения информации о владении
  и правах доступа
- B `Joliet` для длинного имени отводится 64 символа, плюс имя в формате 8.3
- `UDF` (`Universal Disk Format`) - это файловая система, которая позволяет пакетную запись на CD/DVD-диски

Пример использования утилиты `genisoimage` для создания образа диска с файловой системой `iso9660` с расширением `Rock`:
- `genisoimage -r -o cd.iso`

## Создание дисковых разделов

- Утилиты для разметки диска:
    - `fdisk имя_диска`
        - `sudo fdisk -l` - список устройств и разделов
    - `parted имя_диска`
- В настоящее время таблица разделов MBR является устаревшей и следует использовать GPT
- Другие утилиты для создания разделов:
    - `sfdisk` - предназначена для использования в сценариях (скриптах)
    - `cfdisk` - псевдографическая утилита
    - `gparted` - графическая утилита

## Создание файловой системы
- Файловая система создается командой `mkfs`:
    - `mkfs.тип_фс параметры файл_устройства`
- Количество индексных дескрипторов для файловых систем семейства `ext` задается при создании ФС и фиксировано
- Установки, которые применяются при создании ФС по умолчанию, находятся в `/etc/mke2fs.conf`

## Монтирование ФС

- Чтобы отформатированный раздел диска был доступен, нужно "подключить" его к каталогу в дереве ФС (точке монтирования)
- Варианты монтирования ФС:
    - Временное монтирование с помощью `mount`
    - Постоянное монтирование с помощью `/etc/fstab`
    - Монтирование с помощью `systemd`

### Временное монтирование

- Для временного монтирования используется команда:
- `sudo mount /dev/устройство точка_монтирования`
- Точка монтирования должна быть предварительно создана - обычно это пустой каталог (можно использовать каталог `/mnt`)
- Для размонтирования используется один из вариантов
    - `sudo umount /dev/устройство`
    - `sudo umount точка_монтирования`
- Чтобы размонтирование прошло успешно, на устройстве не должно быть занятых файловых ресурсов
    - `fuser` - для решения проблем с размонтированием ФС, команда показывает, какие процессы работают с объектами ФС на
      устройстве и не дают его размонтировать
        - `fuser -mu точка_монтирования`

## Настройка автоматического монтирования при загрузке

- Настройка автоматического монтирования ФС может быть произведена путем соответствующих настроек в `/etc/fstab`
- Файл `/etc/fstab` содержит 6 полей:
    - файл устройства/метка/UUID
    - точка монтирования
    - тип файловой системы
    - параметры (обычно defaults)
    - признак для команды `dump` (обычно 0)
    - признак для команды `fsck` (1 - для корневой ФС, 2 - для остальных)

## Создание юнита для монтирования ФС через `systemd`

- Для монтирование ФС через `systemd` требуется создать юнит типа `mount,` в котором следует описать, какое устройство и
  как должно быть смонтировано
- Название юнита должно совпадать с именем точки монтирования, но вместо символа `/` должен использоваться символ `-`
- В юните должна быть секция `[Mount]` со следующими параметрами:
    - What - имя устройства (имя файла устройства, метка, UUID)
    - Where - точка монтирования
    - Туре - тип ФС
    - Options - параметры монтирования
- `sudo systemctl --force --all edit имя_юнита.mount` - создать юнит

## Монтирование с помощью `systemd`

- `sudo systemctl start имя_юнита.mount` - смонитровать ФС с помощью юнита типа `mount`

## Утилиты для работы с ФС
- `tune2fs` - настройка параметров ФС
- `dumpe2fs` - вывод информации о структуре ФС
- `e2fsck` - проверка целостности структуры ФС
- `resize2fs` - изменение размеров ФС
- `e4defrag` - дефрагментация ФС `ext4`
- `debugfs` - отладчик ФС
- `e2image` - сохранения метаданных ФС в файл
- `df (-h, -i)` - информация о свободном месте в областях данных и `inode`
- `du -sh каталог` - общий размер файлов в каталоге
- `lsblk` - список блочных устройств
