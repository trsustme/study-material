# Процесс загрузки и выключения системы

- Последовательность и стадии загрузки операционной системы Astra Linux
- BIOS(MBR)
- EFI
- GRUB
- Загрузка ядра ОС
    - параметры, передаваемые ядру
- Настройка запуска служб с помощью systemd

---

## Стадии процесса начальной загрузки

1. При подаче питания процессор начинает выполнять код BIOS (в устаревших системах), либо UEFI (в современных системах):
    - происходит тестирование оборудования
    - производится поиск загрузочного устройств
    - загружается программа-загрузчик из записи MBR (для BIOS), либо с EFI-раздела (для UEFI) загрузочного устройства

2. Загрузчик EFI/MBR служит для обнаружения и загрузки GRUB:
    - EFI-загрузчик размещается в разделе ESP (EFI System Partition, отформатированном в FAT32) и имеет имя
      `/EFI/Boot/bootx64.efi`
    - в случае MBR (Master Boot Record) загрузчик размещается в фиксированном месте, в составе записи MBR

3. Загрузчик GRUB (используется GRUB2)
    - показывает загрузочное меню
    - загружает в память ядро linux
    - загружает образ `initramfs` для создания RAM-диска с начальной структурой файловой иерархии для linux и необходимыми
      сценариями и драйверами
    - после чего передает управление ядру linux

4. Ядро linux
    - инициализирует наиболее важные функции (механизм системных вызовов, планировщик задач и т.д.)
    - монтирует в `/` образ `initramfs` и запускает процесс `/sbin/init` с PID=1.

5. Если используется `initramfs` (по умолчанию он используется), то `/sbin/init` выполняет сценарий инициализации,
   загружая необходимые драйвера с RAM-диска.
    - После загрузки драйверов уже можно смонтировать в `/` системный раздел.
    - Монтируется устройство с системой в `/`, и процесс `init` замещается службой `systemd`.

6. служба `systemd` запускает
    - целевое состояние по умолчанию
    - службы
    - виртуальные терминалы
    - графическую подсистему (fly-dm)

7. открывается окно входа, система ожидает входа пользователя.

## BIOS/UEFI

BIOS - 1975 год
EFI - 1998 год
UEFI - 2007 год

BIOS/UEFI - ПО низкого уровня, программа хранится на чипе материнской платы, запускающаяся при старте компьютера перед
тем, как загрузится операционная система.
- можно изменять:
    - аппаратная конфигурация компьютера
    - системное время
    - порядок загрузки
    - и т.д.
- перед загрузкой ОС, проходит POST(Power-On Self Test) - самотестирование настроек аппаратного обеспечения и его
  работоспособность после включения
- после POST BIOS ищет MBR(Master Boot Record) - главную загрузочную запись, которая хранится на загрузочном устройстве
  и используется для запуска загрузчика ОС

BIOS устарел, потому что:
- может загружаться с жестких дисков, объемом не более 2.1 Тб
- должен работать в 16-битном режиме процессора
- доступен 1 Мб памяти

UEFI:
- может загрузиться с жестких дисков, объемом до 9.4 зеттабайт(10^21 байт)
- GPT вместо MBR
- может работать в 32-битном или 64-битном режимах
- адресное пространство больше, чем у BIOS - значит, быстрее загрузка
    - адресное пространство - совокупность всех допустимых адресов каких-либо объектов вычислительной системы
        - обекты вычислительной системы ячейки памяти, секторы диска, узлы сети и т.п.
            - ячейки памяти - электронная схема, которая хранит один бит двоичной информации
- поддерживает Secure Boot - проверка, что загрузку ОС не изменило что-то вредоносное
- поддерживает работу по сети - позволяет удаленно настривать

## MBR/GPT

MBR/GPT - хранят инормацию о разделах накопителя

MBR
- может обрабатывать только 2 ТБ пространства на жестком диске
- имеет размер 512 байт - можно создать до 4 основных разделов
    - два типа раздела:
        - основной/первичный - способен загружать ОС
            - обязан быть
        - дополнительный/вторичный/расширенный - не способен загружать ОС, можно разбивать на логические диски
            - может либо присутствовать в единичном экземпляре, либо нет

GPT(GUID Partition Table) - создан для замены MBR
- максимальная емкость раздела 9.4 Збайт
- в Windows можно создать 128 первичных разделов
- в Linux можно создать 256 первичных разделов

## Система инициализации `systemd`

Служба `systemd` - система инициализации, родитель всех процессов пользовательского пространства.

Основные компоненты `systemd`:
- работает с PID=1
- Юнит (`unit`) - основная единица `systemd`.
    - службы
    - целевые состояния
- `systemd` основан на использовании механизмов, предоставленных ядром Linux:
    - пространств имен (`namespaces`)
    - контрольных групп (`cgroups`)
- `namespaces` - пространства имен - механизм обеспечивающий изоляцию процессов благодаря ограничению видимости тех или
  иных ресурсов ядра Linux путем предоставления процессам собственные экземпляры имен
    - в linux имеются 7 типов пространств имен:
        - cgroups
            - Механизм позволяет образовывать иерархические группы процессов с заданными ресурсными свойствами и
              обеспечивает программное управление ими, задает ограничения на ресурсы (процессор, сеть, память,
              ввод-вывод и т. д.)
        - pid
        - network
        - user
        - mount
        - ipc
        - uts

### Службы `systemd`:
- `systemd-journald` - служба регистрации событий, тесно интегрированная c `systemd`, регистрирует сообщения
    - системного журнала (syslog)
    - ядра (kernel log)
    - сообщения службы выводимые в STDOUT и STDERR
- `systemd-networkd` - служба управления сетевыми соединениями - обнаруживает и настраивает сетевые соединения
- `systemd-logind` - служба, управляющая
    - входом пользователей в систему
    - пользовательскими сеансами
    - создание текстовых терминалов при активации виртуальной консоли
    - обработка клавиш сна/выключения
- `systemd-udevd` - служба управления событиями устройств
    - прослушивает события, поступающие от ядра
    - реагирует на эти события
        - напр., создает/удаляет файлы устройств в /dev при подключении/отключении соответствующих устройств

### Утилиты:
- `systemctl` - основной инструмент управления службами и целевыми состояниями `systemd`
- `journalctl` - инструмент просмотра журналов, формируемых `journald`, обладает гибкими возможностями настройки вывода
  с помощью параметров
- `systemd-notify` - служит для служб типа `notify`.
    - запущенный в качестве службы сценарий с помощью `systemd-notify` может сообщать службе systemd свой статус
- `systemd-analyze` - позволяет проанализировать время загрузки
- `systemd-cgls` - выводит дерево контрольных групп (`cgroup`)
- `systemd-cgtop` - аналог `top` для контрольных групп (`cgroup`)
- `loginctl` - утилита для управления менеджером `systemd-logind`

## Конфигурационные файлы `systemd`

- `/lib/systemd/system` - дефолтные unit-файлы
- `/etc/systemd/system` - кастомные unit-файлы

Используются Unit-файлы(например, см. `man systemd.unit`):
- служба (.service)
- целевое состояние (.target)
- путь (.path)
- таймер (.timer)
- монтирование (.mount) /автомонтирование (.automount)
- устройство (.device)
- подкачка (.swap)

## Управление службами

- `systemctl status юнит.service` - посмотреть статус службы
- `systemctl enable юнит.service` - добавить службу в автозагрузку
- `systemctl disable юнит.service` - удалить службу из автозагрузки
- `systemctl start юнит.service` - запустить службу
- `systemctl stop юнит.service` - остановить службу
- `systemctl restart юнит.service` - перезапустить службу
- `systemctl reload юнит.service` - перечитать конфигурационный файл службы

