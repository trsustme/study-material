# Журналирование в Astra Linux

## Основные системные журналы:

- Основное место хранения журналов `/var/log`. Многие из этих журналов создаются в этом каталоге службой `syslog-ng`
- Основные системные журналы:
    - `syslog` - основной журнал, в котором хранятся все сообщения, кроме сообщений об аутентификации и сообщений почтовой службы
    - `messages` - "урезанный" вариант syslog
    - `auth.log` - хранятся сообщения об аутентификации служб и пользователей
    - `wtmp` - сообщения о сеансах пользователей, перезагрузках системы

Другие системные журналы:
- `/var/log/boot.log` - хранит сообщения, сгенерированные во время загрузки
- `/var/log/kern.log` - хранит сообщения от ядра ОС
- `/var/log/daemon.log` - хранит сообщения от различных служб (кроме почты, печати, cron)
- `/var/log/user.log` - хранит сообщения от команд, выполняемых пользователями
- `/var/log/lastlog` - информация о последних логинах пользователей

## Служба журналирования `syslog-ng`

- Служба журналирования (протоколирования событий) позволяет получать сообщения из разных источников, преобразовывать и
  сохранять их в файлах или передавать по сети на центральный сервер сбора журналов
- Настройка `/etc/syslog-ng/syslog-ng.conf` и `/etc/syslog-ng/conf.d`
- Основные типы объектов `syslog-ng`:
    - источники и драйверы источников (source)
    - приемники и драйверы приемника (destination)
    - фильтры и функции фильтрации (filter)
    - пути (маршруты, log path)

## Источники и драйверы источников

- Синтаксис для записи объекта типа источник:
    - `source идентификатор { драйвер-источника (параметры) ; ...);`
- Поддерживаемые драйверы источников:
    - `file()` - получение из файла (имя файла указывается как параметр)
    - `internal()` - сообщения от `syslog-ng`
    - `network()` - сообщения от удаленных хостов
    - `system()` - сбор стандартных для платформы журналов
    - `systemd-journal()` - сообщения от `journald`
- Пример:
    - `source s_src { system(); internal(); };`

## Приемники и драйверы приемников

- Синтаксис для записи объекта типа приемник:
    - `destination идентификатор { драйвер_приемника (параметры) ; ...);`
- Поддерживаемые драйверы приемников:
    - `file()` - запись в указанный файл
    - `network()` - передача по сети
    - `pipe()` - передача в именованный канал
    - `program()` - передача процессу, запущенному указанной программой
- Пример:
    - `destination d_auth { file("/var/log/auth.log"); };`

### Форматы сообщений о событиях

- Вид сообщения в традиционном BSD-syslog стиле (RFC 3164)
    - `<PRI> дата имя_хоста приложение: сообщение`
- Поле приоритет (PRI) определяет
    - подсистему, от которой получено сообщение (`facility`)
    - уровень критичности (`важности`) сообщения (`severity`)
- Вид сообщения в соответствии с IETF-syslog протоколом (RFC 5424)
    `<PRI> версия ISO_дата имя_хоста приложение PID ID_сообщения структурированные_данные сообщения`

### Фильтры и пути сообщений (log path)

- Синтаксис для фильтров:
    `filter идентификатор (тип_фильтра(фильтрующее_выражение););`
- Поддерживаемые типы фильтров:
    - `facility()` и `level()` - фильтрация по полю PRI
    - `host()` и `netmask()` - фильтрация по имени и адресу хоста
    - `match()` - фильтрация по регулярному выражению (заголовок и сообщение)
    - `message()` - фильтрация по регулярному выражению (сообщение)
- Синтаксис для пути:
    `log {source(s_ID), filter|parser|rewrite(ID), destination(d_ID); };`

### Настройка сервера syslog-ng для централизованного журналирования

- Создать сертификат и приватный ключ для сервера и разместить их в подкаталогах `cert.d`, `key.d`, `ca.d` каталога
  `/etc/syslog-ng`
- В файле `/etc/syslog-ng/syslog-ng.conf` определить:
    - источник, используя драйвер `network(),` указав значения параметров `port`, `transport`, `tls`
    - приемники для логов, которые будут поступать на сервер с клиентов
    - путь сообщений, связав определенные источники и приемники и, если потребуется указать фильтры, анализаторы или
      модификатор правил
- Перезапустить службу `syslog-ng`

### Настройка клиента централизованного журналирования

- Создать сертификат и приватный ключ для клиента, настроить доверие к сертификату сервера
- В файле `/etc/syslog-ng/syslog-ng.conf` определить:
    - приемник для логов, передаваемых на сервер журналирования, используя драйвер `network()` и указав параметры
      `IP-адрес,` `port`, `transport`, `tls`
    - путь логов, связав локальные источники с приемниками на сервере
- Перезапустить службу `syslog-ng`

### Система журналирования `systemd-journald`

- Входит в состав `systemd`
- Конфигурационный файл `/etc/systemd/journald.conf`
- Параметр `Storage` регулирует, где хранится журнал:
    - `volatile` - в `/run/log/journal` (временная память)
    - `persistent` - в `/var/log/journal` (постоянная память)
    - `auto` - если есть каталог `/var/log/journal`, то в нем, если нет, то в `/rur/log/journal` (по умолчанию)

### Ротация журналов - logrotate

- Проверяет все журнальные файлы, перечисленные в конфигурационных файлах
- Конфигурационные файлы `logrotate`:
    - `/etc/logrotate.conf`
    - `/etc/logrotate.d/*.conf`
- Ежедневно отслеживает размер и возраст журнальных файлов (через cron: `/etc/cron.daily/logrotate`)
- Выполняет действия с журнальными файлами в соответствии с указанными в конфигурационных файлах директивах
