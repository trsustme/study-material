# Работа с текстовой информацией

## Стандартные потоки ввода/вывода

При открытии файла процессом в ядре ОС создает структуру - дескриптор файла(число, которое идентифицирует открытый файл внутри процесса)
Структура хранит информацию об открытом файле - состояние(чтение/запись) и позиция для чтения/записи.

Для процесса всегда открыты три потока:
- stdin(дескриптор 0) - стандартный поток ввода
- stdout(дескриптор 1) - стандартный поток вывода
- stderr(дескриптор 2) - стандартный поток ошибок

`lsof` - показывает список открытых файлов в системе

## Перенаправление стандартных потоков в файл или из файла

Перенаправление стандартного входного потока(stdin)
- `< filename`
- `0< filename`

Перенаправление стандартного выходного потока(stdout)
- `> filename`
- `1> filename`
- `>>` - в режиме добавления
- `>&` - перенаправление двух стандартных потоков
- `&>` - перенаправление двух стандартных потоков

Перенаправление стандартного потока ошибок(stderr)
- `2> filename`
- `2>>` - в режиме добавления

`ls nonexistent_file 2> error.log` - сообщение об ошибке будет записано в файл

## Конструкция "документ-здесь"

```bash
bash << EOF > file.txt
> hello
> world
> EOF
cat file.txt
hello
world
```

## Перенаправление стандартных потоков между процессами

Команды в конвеере запускаются параллельно, но каждая следующая команда ожидает данных от предыдущей.
Каждый stdout предыдущей команды становится stdin следующей.

`ps ax | grep bash` - вывод информации о процессе bash

## Команды для просмотра текстовых файлов

`cat filenames` - объединение файлов и перенаправление их в стандартный выходной поток

`tac` - обратно `cat`
    - используется при просмотре журнальных данных

`head filename` - выводит n(10 по умолчанию) первых строк файла

`tail filename` - выводит n(10 по умолчанию) последних строк файла

`less` - постраничный вывод файла

## Команды фильтры

### wc
`wc` - подсчет количества строк, слов и символов

- -l - количество строк
- -c - количество символов
- -w - количетсво слов

`ps -e | wc -l` - подсчет количества процессов

`cat /etc/passwd | wc -l` - подсчет количества учетных записей пользователей

### sort
`sort filename` - сортировка строк в файле

- -n - числовая сортировка
- -r - сортировка по убыванию
- -k список_ полей - сортировка по указанным полям
- -t символ - определение разделителя между полями

`cat /etc/passwd | sort -t: -k 3 -nr` - показ учетных записей пользователей, отсортированных по уменьшению UID

### cut
`cut` - вырезание символов или полей из текстовых строк

- -c диапазон_символов - вырезание указанного диапазона символов
- -f список_полей - вырезание указанных полей
- -d символ - определение разделителя между полями

`cat /etc/passwd | sort -t: -k 3 -nr | cut -d: -f 1,3` - показ учетных записей пользователей, отсортированных по
уменьшению UID, с выводом имени учетной записи пользователя и самим UID

### uniq
`uniq` - показыает или убирает повторяющиеся строки

перед использованием строки должны быть отсортированы

- без параметром - убираются все повторы строк
- -u - оставляются только уникальные строки
- -d - выводятся только строки, которые имели повторы

### tr
`tr` - замена одних символов на другие или удаление символов

`who | tr 'a-z' 'A-Z'` - замены строчных на прописные

- -d - для удаления указанных символов

`cat dosfile.txt | tr -d '\r' > linuxfile.txt` - удаление символа каретки(используется в Windows)

- `ls -l | grep '^d' | tr -s " "  | cut -d" " -f9-` - вывести только имена подкаталогов текущего каталога
- `ls -l | grep '^d' | tr -s " "  | cut -d" " -f9- | tr "\n" " "` - вывести только имена подкаталогов текущего каталога в одной строке
- `ls -l /dev | tr -s ' ' | cut -c 2-9 | sort | uniq -c` - количество комбинаций прав доступа на файлы и каталоги в каталоге /dev

### tee
`tee filename` - одновременное перенаправление стандартного входного потока в файл и в стандартный выходной поток

### nl
`nl` - нумерация строк

### xargs
`xargs` - берет данные из входного потока и использует их как аргументы для другой команды

- -I символы или -i символы - вместо указанных символов подставить данные, которые приходят на вход(по умолчанию
xargs подставляет данные в конец команды)
- -p - каждой сформированное командой xargs действие будет требовать подтверждение(используется для отладки)

`ls file* | xargs -i[] cp [] [].bak` - для всех файлов file... в текущем каталоге создаются их копии с именами, к
которым добавляется суффикс .bak

## Регулярные выражения

Регулярные выражения - это язык для составления шаблонов поиска текстовой информации

`^` - начало строки

`$` - конец строки

`.` - любой символ

`[символы]` - один символ из диапазона

`[^символы]` - один символ не из диапазона

`символы || символы` - или

`(символы)` - группировка символов

`\<слово\>` - слово

`*` - предыдущий символ повторяется 0 или более раз

`+` - предыдущий символ повторяется 1 и более раз

`?` - предыдущий символ повторяется 0 или 1 раз

`{n,m}` - предыдущий символ повторяется от n до m раз

`{n,}` - предыдущий символ повторяется от n раз

`{n}` - предыдущий символ повторяется n раз

`\` - отмена специального значения последующего метасимвола

### Примеры регулярных выражений

`^$` - пустая строка

`^#` - строка, которая начинается с символа #

`^[A-Z]` - строка, начинающаяся с заглавного символа

- `man -s '1,8' -k '^ls'` - вывести список всех пользовательских(1) и административных(8), начинающихся с ls

## Утилита grep

`grep` - ищет строки, соответствующие регулярному выражению, в текстовых потоках
- `grep 'error' logfile.txt`
- `ls -l | grep '^d'` - вывести только подкаталоги текущего каталога

`egrep` (`grep -E`) - поиск с использованием расширенного набора метасимволов регулярных выражений
- +, |, ()
- `grep -E 'cat|dog' animals.txt`

`fgrep` (`grep -F`) - поиск по фиксированной строке, где специальные значения метасимволов игнорируются
- `grep -F 'a+b' data.txt` - строка a+b воспринимается буквально, а не как регулярное выражение

### Флаги grep

- -i - игнорирование регистра символов
- -v - поиск на несоответствие регулярному выражению
- -r - рекурсивный поиск
- -l - выводятся только имена файлов, в которых есть строки, соответствующие регулярному выражению
- -H - перед каждой найденной строкой выводится префикс - имя файла

## Утилита sed

sed - для редактирования текстовых потоков

-i - изменения производятся в указанном файле
- `sed -i 's/old_text/new_text/g' file.txt`

-e - указание нескольких инструкций редактирования
- `sed -e 's/foo/bar/' -e 's/baz/qux/' file.txt`

-E - использования расширенных регулярных выражений
- `sed -E 's/(cat|dog)/animal/g' file.txt`

p - используется для вывода строк, удовлетворяющих определенному условию

-n 'диапазон'- подавляет стандартный вывод всех строк, кроме тех, что в диапазоне
- `ps -el | sed -n '1,10 p'` - вывод первых 10 процессов в системе

d - удаление строк, удовлетворяющих указанному условию
- `ps -el | sed '11,$ d'` - вывод первых 10 процессов, с удалением остальных

- iтекст - вставка текста перед найденной строкой
- aтекст - добавление текста после найденной строки
- `ps -el | head | sed -e '1 i-------' -e '1 a-------'` - вставка текста разделитель после первой строки

- стекст - замена найденной строки на текст
- sтекст - замена строки, соответствующей шаблону на другой текст

## Утилита awk

awk - построчная обработка текстовых потоков

`awk '{print NR - $1 - $4}' employee.txt ` - выводит на экран первый и четвертый столбец с построчной нумерацией

`cat /etc/services | awk ' !/^#/ && /Kerberos/ { print $1, "\t" $2}'` - выводит информацию обо всех портах относящихся к Kerberos в формате имя_службы порт

`ls file*txt | awk '{print "cp " $0 " bak/" $0 ".bak"}' | bash` - создание резервной копии в каталоге bak для всех файлов file...
