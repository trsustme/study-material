# Управление учетными записями пользователей и групп

## Типы пользователей

- Суперпользователь
    - имя root
    - домашний каталог /root
    - UID=0
    - в Astra Linux пароль для root не задан, поэтому войти в систему с использованием учетной записи root нельзя

- Обычные пользователи - учетные записи пользователей, которым разрешен терминальный вход в систему.
    - домашние каталоги размещаются в /home
    - UID с 1000 до 59999

- Системные пользователи - учетные записи, которые нужны для функционирования операционной системы и служб
    - учетные записи с UID/GID от 0 до 99 используются самой ОС и одинаковы для всех систем
    - учетные записи с UID/GID от 100 до 999 используются службами, создаются динамически и могут отличаться

## База данных локальных учетных записей

Локальные учетные записи хранятся в следующих файлах
- `/etc/passwd` - учетные записи пользователей
    - доступно для чтения любому пользователю
    - доступно для записи только суперпользователю
- `/etc/shadow` - пароли пользователей и атрибуты паролей
    - доступно для чтения и записи только суперпользователю
    - доступно для чтения группе shadow
- `/etc/group` - учетные записи групп
    - доступно для чтения любому пользователю
    - доступно для записи только суперпользователю
- `/etc/gshadow` - пароли для групп
    - доступно для чтения и записи только суперпользователю
    - доступно для чтения группе shadow

## Структура файла `/etc/passwd`

Формат строки:
`username:password:UID:GID:GECOS:home_directory:login_shell`
- GID - идентификатор первичной группы.
    - пользователю должна быть назанчена первичная группа.
    - `/etc/group` - перечислены дополнительные вторичные группы
- GECOS - имя пользователя и комментарий
    - может содержать любую информацию об учетной записи пользователя, разделенную запятыми:
        - полное имя пользователя(ФИО)
        - номер комнаты(адрес)
        - номер рабочего телефона
        - номер домашнего телефона
        - другая информация
- Home_directory - абсолютное имя домашнего каталога пользователя
- Login_shell - входной командный интерпретатор - абсолютное имя команды, которая запускается сразу после успешной
аутентификации пользователя

## Структура файла `/etc/shadow`

`username:encrypted_password:last_password_change:minimum_password_age:maximum_password_age:warning_period:inactivity_period:expiration_date:unused`
- encrypted_password - закодированный пароль
    - если содержит символы `*`, `!`, то пользователь не сможет войти в систему, используя аутентификацию по паролю,
    но может использовать другие методы входа в систему, например, аутентификацию на основе ключей
    - алгоритм кодирования указывается в качестве параметра модуля PAM pam_unix.so
        - в ALSE для кодирования паролей используется алгоритм gost12_512,
- last_password_change - дата последнего изменения пароля, в днях, отсчитываемых с 1 января 1970 года
- minimum_password_age - минимальное число дней между изменениями пароля - кол-во дней, которое должно пройти прежде,
чем можно будет изменить пароль пользователя
- maximum_password_age - максимальное число дней между изменениями пароля - кол-во дней до необходимости смены пароля,
значение 99999 - ограничение не установлено
- warning_period - период предупреждения - количество дней до истечения срока действия пароля, в течение которых
пользователя предупреждают о необходимости изменения пароля
- inactivity_period - период бездействия - количество дней бездействия пользователя после истечения срока действия
пароля до блокировки учетной записи пользователя
- expiration_date - срок действия учетной записи - дата, когда учетная запись была отключена
- unused - не используется

## Структура файла `/etc/group`

`groupname:group-password:GID:username-list`
- groupname - имя группы
- group-password - пароль для группы хранится в /etc/gshadow
- GID - числовой идентификатор группы GID
- username-list - список пользователей, для которых эта группа вторичная(дополнительная)

## Структура файла `/etc/gshadow`

`groupname:encrypted_password:group-admins:group-users`
- groupname - имя группы
- encrypted_password - закодированный пароль группы
    - пароль для группы используется в случае, если пользователь, не являющийся членом группы, хочет получить членство
    в данной группе
    - пустое значение - только члены группы могут использовать ее для получения доступа к файлам
- group-admins - члены группы, перечисленные через запятую, которые могут менять пароль или членство в группе
- group-users - обычные пользователи данной группы - тот же список, что и в /etc/group


## Утилиты для управления учетными запсями

- `/etc/login.defs` - настройки по умолчанию, которые используются утилитами для создания, изменения и удаления учетных записей

### Утилиты для создания учетных записей `useradd` и `groupadd`

Пароль нужно задавать отдельно, с помощью утилиты passwd.

- `useradd параметры имя_пользователя` - создание учетной записи пользователя
    - `-m` - в Astra Linux для создания домашнего каталога
    - файлы настроек(.bashrc, .profile и др.) копируются из каталога `/etc/skel` в домашний каталог пользователя
    - `sudo useradd -s /bin/bash -d /home/bob -m bob` - создание обычной учетной записи пользователя
    - `sudo useradd -u 666 -s /usr/sbin/nologin -d /etc/myserver -M myserver` - создание системной учетной записи пользователя

- `groupadd параметры имя_пользователя` - создание учетной записи группы

### Изменение и удаление учетных записей `usermod` и `userdel`, `groupmod` и `groupdel`

- `usermod` - изменение параметров учетной записи пользователя
    - `sudo usermod -aG astra-admin user1` - добавление пользователя user1 в группу astra-admin

- `userdel` - удаление учетной записи пользователя
    - перед удалением учетной записи пользователя следует:
        - решить, что сделать с файлами пользователя(`find / -user ...` - найти все файлы)
        - требуется ли удалить основную(первичную) группу пользователя(обычно приватная основная группа удаляется автоматически)

- `groupmod` - изменение параметров учетной записи группы

- `groupdel` - удаление учетной записи группы
    - перед удалением учетной записи группы следует:
        - решить, что сделать с файлами, у которых указана данная группа
        - решить, какую группу сделать основной(первичной) для тех пользователей, у которых удаляемая группа была основной
    - вместо удаления можно использовать блокировку:
        - `usermod -e 1 имя_учетной_записи_пользователя` - блокировка учетной записи, устанавливает дату устаревания
        учетной записи 2 января 1970 г.

## Управление паролями

`passwd` - установить, изменить или настроить пароль пользователя
- root может изменить пароль или его атрибуты для любого пользователя

`chage` - установить или просмотреть атрибуты пароля и учетной записи

`gpasswd` - установить пароль для группы

## Альтернативные утилиты для управления учетными записями

`adduser` - создание учетной записи пользователя

`addgroup` - создание учетной записи группы

`deluser` - удаление учетной записи пользователя

`delgroup` - удаление учетной записи группы

Настройки этих утилит находятся:
- `/etc/adduser.conf`
- `/etc/deluser.conf`

`vipw` - редактирование /etc/passwd
`vigr` - редактирование /etc/group
`vipw` - редактирование /etc/shadow

## Дополнительные утилиты для работы с учетными записями

`chsh -s имя_интерпретатора` - изменение входного командного интерпретатора в /etc/passwd
    - обычный пользователь может сменить только на интерпретаторы, которые находятся в /etc/shells

`chfn` - изменение поля "комментарий" GECOS в /etc/passwd
    - обычный пользователь может сменить только поля номер комнаты и номер телефонов

`su имя_пользователя` - запуск последующих команд от имени другого пользователя
    - `su` == `su root`

`su -user_name` - при запуске команды инициализируются переменные окружения указанного пользователя

`newgrp имя_группы`, `sg имя_группы` - смена первичной группы в рамках сеанса

`id имя_пользователя` - вывод имен учетных записей группы в рамках сеанса

`lslogins -u -o=USER,GROUP,GID,SHELL,PWD-MAX,PWD-MIN,PROC,LAST-LOGIN` - получить информацию об учетных записях
пользователей, атрибутах паролей, информацию о сеансах пользователей

## Управление учетными записями в графическом интерфейсе

`fly-admin-smc` - управление политикой безопасности

## Настройка окружения пользователя при работе в командном интерпретаторе bash

Когда bash - входной интерпретатор, то запускаются следующие сценарии:

Системные настройки:

1) `/etc/profile` - системный профильный файл
2) `/etc/bash.bashrc` - файл, содержащий системные настройки для bash
3) `/etc/profile.d` - каталог с файлами с расширением .sh

Пользовательские настройки:

4) `~/.profile` - пользовательский профильный файл
5) `~/.bashrc` - пользовательские настройки для bash

Если bash - не входной интерпретатор, то выполняются только:
`/etc/bash.bashrc`
`~/.bashrc`

## Настройка рабочего стола Fly

`/usr/share/applications` - находятся ярлыки установленных графических приложений - файлы с расширением .desktop


## Архитектура PAM

PAM (Pluggable Authentication Modules - подключаемые модули аутентификации) - это набор .so, которые позволяют
интегрировать различные низкоуровневые методы аутентификации в виде единного высокоуровнего API.

Когда запускается программа, требующая аутентификацию, к ней "подключаются" модули PAM.

Все конфигурационные файлы, связанные с PAM для различных приложений, хранятся в каталоге `/etc/pam.d`.

## Типы модулей PAM

`auth` – аутентификация пользователей - проверяет, корректно ли введён пароль или другой способ аутентификации.
Это первый этап, который подтверждает личность пользователя.

`account` – проверка доступа - проверяет, имеет ли пользователь право на доступ.

`session` – настройка и управление сессиями - этот модуль отвечает за настройку окружения пользователя во время сессии.

`password` – управление сменой пароля - отвечает за изменение пароля пользователем.


`man -k pam_` - получить список установленных в системе pam модулей

## Управляющие флаги

Флаги PAM определяют, как именно PAM модули обрабатывают запросы на аутентификацию и авторизацию.

Существуют следующие флаги:

- requisite (необходимый):
Если модуль, помеченный этим флагом, вернёт отрицательный ответ, запрос сразу же отклоняется, и дальнейшие модули не
будут выполнены.

- required (требуемый):
Если хотя бы один из модулей, помеченных как required, вернёт отрицательный ответ, то весь процесс аутентификации
будет отклонён.

- sufficient (достаточный):
Если модуль, помеченный как sufficient, возвращает положительный ответ, то дальнейшие модули больше не обрабатываются,
и пользователь получает доступ.

- optional (дополнительный):
Эти модули будут выполняться только в случае, если они находятся в стеке, но не являются решающими.

---

- `sudo usermod -aG cdrom имя_пользователя` - добавить пользоавтеля в дополнительную группу cdrom, не затрагивая существующих

- `sudo usermod -L имя_пользователя` - заблокировать учетную запись пользователя
- `sudo passwd -l имя_пользователя` - заблокировать учетную запись пользователя

- `sudo useradd -u 666 -s /usr/sbin/nologin -d /etc/myserver -M myserver` - создание системной учетной записи службы myserver

Создать учетную запись user1 параметрами:
- UID 1500
- основная первичная группа user1 (GID 1500)
- дополнительная группа video
- домашний каталог должен быть создан
- входной командный интерпретатор - /bin/bash
- задать пароль
- время действия пароля - 60 дней
- пользователь должен сменить пароль при первом входе в систему
```bash
sudo groupadd -g 1500 user1 # Создание группы с GID 1500
sudo useradd -u 1500 -g user1 -G video -s /bin/bash -m users # Создание пользователя с UID 1500, привязка его к основной группе и создание дом. каталога
sudo passwd user1 # Установка пароля для пользователя
sudo chage -M 60 user1 # Установка срока действия пароля
sudo passwd -e user1 # Принудительная смена пароля при первом входе
```

Проверить атрибуты созданной учетной записи:
```bash
id user1
chage -l user1
lslogins user1
```

