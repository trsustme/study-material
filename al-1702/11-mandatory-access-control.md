# Мандатное управление доступом

## Режимы работы СЗИ

Режим работы ОС определяется в файле `/etc/astra_license`, где задается параметр `MODE`.

## Мандатный контроль целостности

Мандатный контроль целостности — это механизм, который распределяет компоненты системы по определённым уровням
целостности

### 1.6
Уровни целостности:
- 0 – самый низкий уровень целостности
- 63 – высокий уровень целостности
- 127 – самый высокий уровень "Брест"

Система использует неиерархические уровни целостности, где каждый процесс или файл получает определённый уровень, и
они напрямую не сравниваются между собой

### 1.7
Для объектов и субъектов системы задаются два типа уровней целостности:
1) Неиерархические уровни (категории)
    - несколько сегментов, каждый из которых может иметь своё значение целостности
    - значения от `0; 255`
2) Иерархические уровни (линейные)
    - диапазон `[-128; 127]`
    - чем выше числовое значение, тем выше уровень целостности

Уровень целостности объекта
- отражает степень уверенности в целостности содержащейся в нем информации

Уровень целостности субъекта
- соответствует его полномочиям по доступу к сущности в зависимости от их уровней целостности
- отражает степень уверенности в корректности его функциональности


При установке ОС по умолчанию предлагается максимальный уровень неиерархической целостности - `max_ilev` (maximum
integrity level) - равен 63.
Минимальный уровень всегда равен 0.
- `/sys/module/parsec/parameters/max_ilev`

## Механизмы МРД

- Субъект мандатного доступа - тот, кто выполняет операции, подлежащие мандатному контролю - пользователь или процесс
- Объект(сущность) мандатного доступа - то, с чем выполняются операции, подлежащие мандатному контролю - файл
- Контейнер - структурированный объект доступа, т.е. объект, который может содержать другие объекты доступа(каталоги или файлы)

Субъекты и оъекты, которым явно не задан мандатный контекст, считаются имеющими кинимальный (нулевой) мандатный контекст:
- метка безопасности
- мандатные атрибуты

### Иерархический уровень конфиденциальности

Определяет степень секрентности объекта и соответствующий уровень доступа к этому документу, назначенный субъекту.

Субъекту с определенным уровнем конфиденциальности разрешено читать только документы с таким же уровнем
конфиденциальности (или ниже) и запрещено читать документы с более высоким уровнем конфиденциальности.

А также субъекту с более высоким уровнем конфиденциальности запрещено передавать документы высокого уровня
конфиденциальности субъекту с более низким уровнем конфиденциальности.

### Неиерархический уровень(категория) конфиденциальности - разделение по категориям конфиденциальности.

Субъект, работающий с первой категорией конфиденциальности, имеет соответствующую категорию конфиденциальности.

При этом, не имея вторую категорию конфиденциальности, субъект не может иметь доступ к материалам второй категории
конфиденциальности, а также не может передавать материалы первой категории конфиденциальности субъекту, не имеющему
первую категорию конфиденциальности.

Доступ может быть предоставлен одновременно к нескольким категориям конфиденциальности

### Уровень целостности

Неиерархический уровень целостности и иерархический уровень целостности - субъект, работающий на некотором уровне
целостности, может записывать только объекты своего или более низкого уровня целостности.

Иерархический уровень целостности в ОС зарезервирован, и на уровне пользователя не поддерживается его использование

Путем использования уровней и категорий конфиденциальности обеспечивается защита от несанкционированного доступа к информации в части:
- невозможности прочитать информацию, к которой не предоставлен доступ:
    - нижним уровням конфиденциальности запрещено читать информацию с верхних уровней конфиденциальности;
    - всем запрещено читать информацию, на которую нет разрешенной категории конфиденциальности.
- невозможности передать информацию тому, кому не предоставлен доступ:
    - верхним уровням конфиденциальности запрещено записывать свою информацию на нижние уровни конфиденциальности;
    - всем запрещено передавать информацию тем, у кого нет соответствующей категории конфиденциальности.

## Подсистема безопасности PARSEC

Управление мандатным доступом реализовано на основе подсистемы безопасности PARSEC
- PARSEC экспортирует переменные в псевдо ФС `/parsecfs`
- `cat /parsecfs/version` - получить версию PARSEC

- Модуль ядра `parsec.о` реализует основную функциональность подсистемы безопасности
- Модуль `parsec-cifs.ko` поддерживает мандатный доступ для CIFS

- Настройки хранятся в `/etc/parsec`
- `/etc/security` находятся символические ссылки

Система мандатного доступа определяет, какие операции (чтение, изменение) могут выполнять субъекты (процессы,
запущенные пользователем) над объектами (файлами, каталогами).

- Каждому объекту назначается метка безопасности (мандатная метка).
- Каждой учетной записи назначаются допустимые уровни мандатного доступа.

При входе в систему пользователь выбирает, с какими значениями мандатных уровней (мандатный контекст) будет работать
пользователь в сеансе.
Процессы, запущенные пользователем в рамках сеанса, наследуют мандатный контекст, выбранный пользователем при входе.

Доступ к объекту определяется путем сравнения метки безопасности объекта и мандатного контекста процесса:
- если мандатный контекст субъекта совпадает с меткой безопасности объекта, то субъект может и читать и изменять содержимое объекта;
- если мандатный контекст субъекта больше метки безопасности объекта, то субъект может только читать содержимое объекта;
- если мандатный контекст субъекта меньше метки безопасности объекта, то субъект не может получить доступ к объекту.

Пользователь не может изменять метки безопасности файлов и каталогов.

Итоговые права доступа к файлам и каталогам определяются совместным применением дискреционных и мандатных прав.

Включение и отключение механизма контроля целостности в ядре можно осуществить с помощью:
- `astra-mac-control` - вкл/отк возможность работы с объектами, имеющими ненулевую метку конфиденциальности (по умолчанию - включено)

## Состав метки безопасности

Метка безопасности (мандатная метка) состоит из:
- Классификационной метки
- Метки целостности
- Дополнительных необязательных атрибутов (ccnr, ehole, whole)

Классификационная метка состоит из:
- Иерархического уровня конфиденциальности (1 байт: 256 уровней)
- Неиерархической категории конфиденциальности (8 байт: 64 категории)

Обычные пользователи работают с низким уровнем целостности (0), администраторы системы должны работать с высоким уровнем целостности (63).

Дочерний процесс полностью наследует метку безопасности родительского процесса.

Когда процесс создает файл, то файл наследует только классификационную метку процесса. Файл получает нулевую метку целостности.

Принятие решения о запрете или разрешении доступа субьекта к объекта принимается на основе типа операции
(чтение/запись/исполнение), мандатного контекста безопасности субъекта и мандатного контекста безопасности объекта.

## Дополнительные мандатные атрибуты для каталогов

- `ccnr` - каталог может содержать файлы и каталоги с различными классификационными метками, но не большими, чем его собственный

Неиспользуемые атрибуты(сохранены для обеспечения совместимости):
- `ccnri` - каталог может содержать файлы и каталоги с различными уровнями целостности, но не большими, чем собственный
- `ccnra`=ccnr+ccnri (например, каталог /)

- `ehole` - файл, имеющий минимальную классификационную метку, игнорирует правила управления мандатным доступом к нему,
процессы не могут прочитать данные, записанные в такие файлы (пример: /dev/null)

- `whole` - файл, имеющий максимальную классификационную метку, разрешает процессам, имеющим более низкую классификационную метку, записывать в них

## Команды для определения уровней мандатного доступа

- `fly-admin-smc` - графическая утилита
- `userlev` - просмотр и определение уровней конфиденциальности
- `/etc/parsec/mac_levels` - уровни конфиденциальности
- `usercat` - просмотр и определение категорий
- `/etc/parsec/mac_categories` - категории

Если добавляется новый уровень конфиденциальности, то нужно:
- в скрипте `/usr/sbin/pdp-init-fs` установить значение переменной `sysmaxlev`, равное новому максимальному значению уровня
- выполнить скрипт `/usr/sbin/pdp-init-fs`

## Команды для задания меток и атрибутов безопасности

- `fly-fm` - графический файловый менеджер
- `pdpl-file` - просмотр и задание меток и атрибутов безопасности файлам и каталогам.
- `pdp-ls -M` - просмотр меток безопасности, поддерживаются все флаги ls

## Определение мандатных уровней для учетных записей

Учетным записям пользователей можно задать минимальные и максимальные уровни конфиденциальности, категорий и целостности(утилиты pdpl-user и fly-admin-smc)
- `sudo pdpl-user -l 0:3 user12`

При входе в сеанс (через виртуальную консоль или fly-dm) пользователь выбирает уровни конфиденциальности и целостности, а также набор категорий

- `рар-id` выводит информацию о мандатном контексте (о том, с какими мандатными уровнями работает пользователь)

## PARSEC привилегии пользователей

В дополнение к стандартным для Debian привилегиям пользователей в PARSEC определяется свой набор привилегий

`man capabilities` - информация по Debian привилегиям

- Привилегии дают процессу специальные возможности (которых нет у обычных пользователей), такие как право выключения
компьютера или доступа к файлам.
- Привилегии делят полномочия суперпользователя на несколько прав, которые можно присвоить процессам.

Привилегии являются атрибутом потока.
B Linux каждый процесс имеет пять 64-битных чисел (наборов), содержащих биты разрешений, которые можно посмотреть в `/proc/<pid>/status`

Примеры PARSEC- и Linux- привилегий:
- `cap_chown(0)` - Linux привилегия, позволяющая "завладеть" любым файлом (право на выполнение команды chown)
- `parsec_cap_unsafe_setxattr(12)` - PARSEC привилегия, которая позволяет устанавливать метки безопасности на файлы и каталоги, без учета метки безопасности родительского каталога.

## Утилиты для управления привилегиями

- `usercaps`, `fly-admin-smc` - для назначения привилегий пользователям

- `/etc/parsec/capdb`, `/etc/parsec/capabilities` - назначенные пользователям привилегии

- `execaps` - для запуска нового процесса с установленной привилегией

- `pscaps` - для просмотра и изменения привилегий существующего процесса

---

`pdpl-file 0:63:0:0 /home/dir123` - установить на каталог уровень целостности - Высокий
