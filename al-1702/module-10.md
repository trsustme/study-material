# Дискреционное управление доступом

`stat file.txt` - отобразить статус файла или файловой системы

## Индексный дескриптор файла (inode):

- UID (User ID) - идентификатор пользователя, который владеет файлом.
- GID (Group ID) - идентификатор группы, которой принадлежит файл.
- Права доступа - выделено 12 бит для хранения прав доступа к файлу. Эти права определяют, кто и что может делать с
файлом (читать, записывать, выполнять).

Назначение прав доступа для трёх классов пользователей:
- Владелец файла - это пользователь, чей UID указан в inode.
- Группа - это группа пользователей, чей GID совпадает с GID файла.
- Остальные пользователи - это все остальные пользователи, чьи UID не совпадают
  с UID файла, и которые не принадлежат группе-владельцу файла.

## Трактовка прав доступа для файлов и каталогов

Права для файлов:
- r - чтение содержимого файла
- w - изменение содержимого файла
- x - выполнение файла (если это исполняемый файл или скрипт)

Права для каталогов:
- r - просмотр списка файлов в каталоге (например, ls)
- w - создание или удаление файлов в каталоге (например, touch).
- x - права доступа к файлам в каталоге (например, cd или поиск в каталоге)

Для каждого из трёх классов пользователей (владелец, группа, остальные) можно назначить три вида прав:
- read - право на чтение
- write - право на запись (изменение)
- execute - право на выполнение (для файлов) или доступ (для каталогов)

Если право x не установлено для каталога, то доступ ко всему его содержимому (и вложенным каталогам) блокируется,
независимо от наличия прав на чтение или запись. (т.е., если пользователь имеет права на чтение или запись файлов,
без права выполнения  он не сможет перейти в каталог и получить к нему доступ)

## Специальные биты защиты

- suid (SetUID) - если установлен этот бит, то любой процесс, который выполняется с этим файлом, будет исполняться с
правами владельца файла, а не пользователя, который его запускает.

- sgid (SetGID) - если установлен этот бит на файл, то файл будет исполняться с правами группы-владельца файла.
    - если этот бит установлен на каталоге, то все файлы и каталоги, созданные внутри этого каталога, будут наследовать
    группу-владельца каталога, а не группу пользователя, который создает файл

- sticky bit - применяется в основном к каталогам. Если sticky bit установлен на каталоге, то файлы в этом каталоге
могут быть удалены только их владельцами, даже если другие пользователи имеют права на запись в этот каталог.

## Символьная и числовая формы записи прав

Числовая форма записи представляет права в виде четырехзначного числа:
- первая цифра отвечает за специальные биты:
    - 4 - suid - s
        - `rws r-x r-x` = 4755
    - 2 - sgid - s
    - 1 - sticky bit - в символьной форме t выводится в последней позиции
        - `rwx r-x r-t` = 1755
- следующие три цифры представляют права для владельца, группы и остальных:
    - чтение - 4
    - запись - 2
    - выполнение - 1

`rws r-s r-t` - 7755

маленькая буква - под ней бит
большая буква - под ней нет бита

`rwx -ws --x` - 2731
`rwx -wS --x` - 2721

## Просмотр прав доступа

- `ls -l filename`
- `ls -ld dirname`
- `stat filename`

В графике - менеджер файлов fly-fm Контекстное меню/Свойства

## Управление правами доступа

`chown` - изменение владельца файла или каталога
- `chown [-R] user_name file_name` - меняет владельца файла на user_name
    - -R - позволяет изменить владельца для всех файлов и каталогов, начиная с указанного каталога
- команду chown может выполнить только администратор системы (root)
- `chown user_name:group_name file_name` - изменить владельца файла на user_name и группу файла на group_name
- `chown 1001 file_name` - изменить владельца на пользователя с UID 1001

`chgrp` - позволяет изменить группу, которой принадлежит файл или каталог
- `chgrp [-R] group_name file_name` - меняет группу файла на group_name.
    - -R - позволяет изменить владельца для всех файлов и каталогов, начиная с указанного каталога
- команду chgrp может выполнить либо администратор (root), либо владелец файла, если он сам состоит в группе, на которую меняется файл
- `chgrp 1002 file_name` - изменить группу файла на группу с GID 1002

`chmod` - изменяет права доступа (чтение, запись, выполнение) для владельца, группы и остальных пользователей
- `chmod 755 file_name` - задает права чтения, записи и выполнения для владельца и только чтение/выполнение для группы и остальных пользователей
- `chmod g+w,o-r file_name` - добавляет группе права на запись и убирает остальным пользователям право на чтение
- -R - позволяет изменить права доступа рекурсивно
- `chmod a+x script1` - установить разрешение выполнять файл всем пользователям

`umask` - маска режима доступа - определяет права, которые будут удалены из создаваемых файлов и каталогов.
Это начальный уровень прав, от которого отнимаются права, указанные в маске.
- `umask` - получить текущее значение, которое покажет, какие права будут исключены при создании файлов и каталогов
- `umask 022` - то создаваемые файлы будут иметь права 755
- маску можно задать тремя способами:
    - внести значение маски прямо в строку с `pam_umask.so` в конфигурации сессии
    - определить значение переменной UMASK в файле `/etc/default/login`
    - задать значение переменной UMASK в файле `/etc/login.def`
    - пользователь может задать значение umask=значение в `~/.profile`

## Списки управления доступом (ACL)

ACL (Access Control Lists) - это механизм, который позволяет назначать стандартные права доступа (rwx) для
пользователей и групп на файлы или каталоги

POSIX ACL является стандартом для управления расширенными правами доступа в Unix-подобных системах

Типы записей ACL:
- ACL для пользователя: определяет права для конкретного пользователя.
    - пример записи: `user:имя_пользователя:права` или в сокращённой форме `u:имя_пользователя:права`
- ACL для группы: назначает права для группы пользователей.
    - пример записи: `group:имя_группы:права` или сокращённо `g:имя_группы:права`
- Маска: задаёт максимальные возможные права для всех пользователей и групп, указанных в соответствующих ACL.
    - пример: `mask::права` или сокращённо `m::права`

## Утилиты для просмотра ACL

Признак наличия ACL у файла:
- `ls -l` - если у файла установлены ACL, то после стандартных прав доступа появляется символ +
    - пример: в выводе -rw-rw-r--+ символ + после прав указывает, что на файл назначены расширенные права через ACL

Просмотр установленных ACL:
- `getfacl file123` - просмотр подробной информации об ACL, показывает:
    - имя файла
    - владелец файла
    - группа владельца
    - права доступа

## Утилиты для изменения ACL

- `setfacl флаг [списки_доступа] имя_файла` - установить или изменить ACL

- `setfacl -m u:user1:rwx Dir` - дать пользователю user1 права на чтение, запись и выполнение для всех файлов и
каталогов внутри Dir

## Атрибуты файлов

`lsattr filename` - просмотр установленных атрибутов файла

`chattr +имя_атрибута имя_файла` - установка атрибута
`chattr -имя_атрибута имя_файла` - снятие атрибута

Основные атрибут(может устанавливать/снимать только root):
- i (immutable): если атрибут установлен, файл не может быть изменён, удалён или переименован никаким пользователем, включая root.
- a (append): если атрибут установлен, файл нельзя удалить или изменить, можно только дописывать информацию в конец файла.


